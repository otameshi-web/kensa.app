<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>東芝 電磁接触器 選択</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <style>
    body { background:#000; color:#fff; }
    .brand-orange { background:#ff6600; }
    select, input { color:#000; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">
  <div class="absolute top-4 right-4">
    <a href="/logout" class="text-sm text-orange-400 hover:underline">ログアウト</a>
  </div>

  <div class="w-full max-w-lg bg-gray-900 p-6 rounded-xl shadow-xl mt-10">
    <h1 class="text-xl font-bold text-center brand-orange py-2 rounded mb-6">
      東芝 電磁接触器 選択
    </h1>

    <div class="bg-gray-800 text-sm p-4 rounded mb-6">
      <p><strong>管理番号：</strong>{{ kanri }}</p>
      <p><strong>現場名：</strong>{{ genba }}</p>
    </div>

    <form id="toshiba-form" class="space-y-4"></form>
  </div>

  <script>
    const form = document.getElementById("toshiba-form");

    // 電磁接触器側の選択
    const selected = {};
    // UPS側の選択
    let upsSelected = {};
    // UPS「有無」を重複表示させない
    let upsFlowStarted = false;

    // ★ 非同期の重複描画を抑止するトークン
    let proceedToken = 0;
    let upsProceedToken = 0;

    // 「該当型式無」→現地型式入力
    const TARGET_MODEL_FIELDS = new Set([
      "電動機主回路用接触器型式",
      "ブレーキ用接触器型式",
      "ブレーキ用接触器型式②",
    ]);
    const NO_MODEL_TEXT = "該当型式無";
    const LOCAL_SUFFIX = "_現地型式";

    // 既存ノード置換のためのヘルパ
    function removeFieldNode(field) {
      const exist = form.querySelector(`[data-field="${CSS.escape(field)}"]`);
      if (exist) exist.remove();
    }

    // コメント表示
    function addCommentBox(field, text) {
      removeFieldNode(field);

      const wrap = document.createElement("div");
      wrap.className = "mb-4";
      wrap.dataset.field = field;

      const label = document.createElement("div");
      label.className = "mb-1 font-semibold";
      label.textContent = field + "（コメント）";

      const box = document.createElement("div");
      box.className = "p-3 rounded bg-gray-800 text-sm";
      box.textContent = text || "—";

      wrap.appendChild(label);
      wrap.appendChild(box);
      form.appendChild(wrap);
    }

    // 現地型式入力UI
    function removeLocalModelInput(container){
      const olds = container.querySelectorAll("[data-local-model]");
      olds.forEach(n => n.remove());
    }
    function showLocalModelInput(container, field){
      removeLocalModelInput(container);
      const wrap = document.createElement("div");
      wrap.dataset.localModel = "true";
      wrap.className = "mt-2";

      const row = document.createElement("div");
      row.className = "flex items-center gap-2";

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "現地型式を入力（半角英字・ハイフン）";
      input.required = true;
      input.pattern = "^[A-Za-z-]+$";
      input.title = "半角英字とハイフンのみ";
      input.className = "flex-1 p-2 rounded text-black";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = "確定";
      btn.className = "px-3 py-2 rounded bg-yellow-500 text-black font-bold";

      btn.addEventListener("click", () => {
        if (!input.reportValidity()) return;
        const v = input.value.trim();
        if (!v) return;
        selected[`${field}${LOCAL_SUFFIX}`] = v;
        proceedAfter(container);
      });

      row.appendChild(input);
      row.appendChild(btn);

      const helper = document.createElement("div");
      helper.className = "text-xs text-gray-300 mt-1";
      helper.textContent = "※必須。例: CA811-FAT";

      wrap.appendChild(row);
      wrap.appendChild(helper);
      container.appendChild(wrap);
    }

    // 結果ボタン
    function addResultButton(){
      if (document.getElementById("show-result-btn")) return;
      const btn = document.createElement("button");
      btn.id = "show-result-btn";
      btn.type = "button";
      btn.className = "mt-4 w-full py-2 rounded bg-yellow-500 text-black font-bold";
      btn.textContent = "結果を表示";
      btn.addEventListener("click", async () => {
        const res = await fetch("/inspection/contact/toshiba/result", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ selected, ups: upsSelected })
        });
        const html = await res.text();
        const w = window.open("","_self");
        w.document.open(); w.document.write(html); w.document.close();
      });
      form.appendChild(btn);
    }

    // セレクト（電磁接触器）
    function makeSelect(field, options, autoSelect=false){
      removeFieldNode(field);

      const wrap = document.createElement("div");
      wrap.className = "mb-4";
      wrap.dataset.field = field;

      const label = document.createElement("label");
      label.className = "block mb-1";
      label.textContent = field;

      const sel = document.createElement("select");
      sel.className = "w-full p-2 rounded";
      if (!autoSelect) sel.appendChild(new Option("選択してください",""));
      options.forEach(o => sel.appendChild(new Option(o,o)));

      sel.addEventListener("change",(e)=>{
        const val = e.target.value;
        if (!val) return;
        selected[field] = val;

        if (TARGET_MODEL_FIELDS.has(field) && val === NO_MODEL_TEXT){
          delete selected[`${field}${LOCAL_SUFFIX}`];
          showLocalModelInput(wrap, field);
          return; // 入力確定時に proceedAfter() が呼ばれる
        } else if (TARGET_MODEL_FIELDS.has(field)) {
          delete selected[`${field}${LOCAL_SUFFIX}`];
          removeLocalModelInput(wrap);
        }

        proceedAfter(wrap);
      });

      wrap.appendChild(label);
      wrap.appendChild(sel);
      form.appendChild(wrap);

      if (autoSelect && options.length===1){
        sel.value = options[0];
        selected[field] = options[0];
        if (TARGET_MODEL_FIELDS.has(field) && sel.value===NO_MODEL_TEXT){
          showLocalModelInput(wrap, field);
          return;
        }
        proceed();
      }
    }

    function proceedAfter(container){
      let hit=false;
      Array.from(form.children).forEach(child=>{
        if (child===container){ hit=true; return; }
        if (hit) form.removeChild(child);
      });
      proceed();
    }

    async function fetchOptions(){
      const res = await fetch("/inspection/contact/toshiba/options",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ selected })
      });
      return await res.json();
    }

    // ================== UPS 追加フロー ==================
    function makeUpsHaveSelector(){
      const field = "停電時自動着床装置の有無";
      removeFieldNode(field);

      const wrap = document.createElement("div");
      wrap.className = "mb-4";
      wrap.dataset.field = field;

      const label = document.createElement("label");
      label.className = "block mb-1";
      label.textContent = field;

      const sel = document.createElement("select");
      sel.className = "w-full p-2 rounded";
      sel.appendChild(new Option("選択してください",""));
      ["有","無"].forEach(o=>sel.appendChild(new Option(o,o)));

      sel.addEventListener("change",()=>{
        const v = sel.value;
        if (!v) return;
        selected[field] = v;

        // ここでは結果ボタンを出さない（UPSフロー完了まで待つ）
        proceedAfter(wrap);
        upsFlowStarted = true;

        if (v === "無"){
          // UPS不要 → そのまま結果へ
          addResultButton();
        }else{
          // UPSフロー開始
          upsSelected = {};
          upsProceed();
        }
      });

      wrap.appendChild(label);
      wrap.appendChild(sel);
      form.appendChild(wrap);
    }

    async function upsFetchOptions(){
      const res = await fetch("/inspection/contact/toshiba/ups/options", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ baseSelected: selected, upsSelected })
      });
      return await res.json();
    }

    function makeUpsSelect(field, options, autoSelect=false){
      removeFieldNode(`UPS:${field}`);

      const wrap = document.createElement("div");
      wrap.className = "mb-4";
      wrap.dataset.field = `UPS:${field}`;

      const label = document.createElement("label");
      label.className = "block mb-1";
      label.textContent = field + "（UPS）";

      const sel = document.createElement("select");
      sel.className = "w-full p-2 rounded";
      if (!autoSelect) sel.appendChild(new Option("選択してください",""));
      options.forEach(o=>sel.appendChild(new Option(o,o)));

      sel.addEventListener("change",()=>{
        const v = sel.value;
        if (!v) return;
        upsSelected[field] = v;
        upsProceedAfter(wrap);
      });

      wrap.appendChild(label);
      wrap.appendChild(sel);
      form.appendChild(wrap);

      if (autoSelect && options.length===1){
        sel.value = options[0];
        upsSelected[field] = options[0];
        upsProceed();
      }
    }

    function upsProceedAfter(container){
      let hit=false;
      Array.from(form.children).forEach(child=>{
        if (child===container){ hit=true; return; }
        if (hit) form.removeChild(child);
      });
      upsProceed();
    }

    async function upsProceed(){
      const myToken = ++upsProceedToken;
      const data = await upsFetchOptions();
      if (myToken !== upsProceedToken) return;   // 古い呼び出しは破棄

      if (data.upsDone){
        // UPSフロー完了 → ここで初めて結果ボタンを出す
        addResultButton();
        return;
      }

      if (data.skip){
        upsSelected[data.field] = "";
        upsProceed();
        return;
      }

      if (data.auto_fill !== undefined){
        // 自動入力（フェールセーフ）は表示のみ（変更不可）
        const field = data.field; // "主回路電磁接触器フェールセーフ該当有無"
        removeFieldNode(`UPS:${field}`);

        const wrap = document.createElement("div");
        wrap.className = "mb-4";
        wrap.dataset.field = `UPS:${field}`;

        const label = document.createElement("div");
        label.className = "mb-1 font-semibold";
        label.textContent = field + "（UPS：自動設定）";

        const box = document.createElement("div");
        box.className = "p-2 rounded bg-gray-800 text-sm";
        box.textContent = data.auto_fill || "—";

        wrap.appendChild(label);
        wrap.appendChild(box);
        form.appendChild(wrap);

        upsSelected[field] = data.auto_fill || "";
        upsProceed();
        return;
      }

      if (data.options){
        makeUpsSelect(data.field, data.options, data.auto_select);
        return;
      }
    }

    // ================== 既存フロー ==================
    async function proceed(){
      const myToken = ++proceedToken;
      const data = await fetchOptions();
      if (myToken !== proceedToken) return;     // 古い呼び出しは破棄

      if (data.done && data.result_ready){
        // 電磁接触器フロー完了 → UPS対象なら有無、対象外なら結果へ
        if (selected["停電時自動着床装置検査対象"] === "対象") {
          if (!upsFlowStarted) {
            // 「有無」を出す（ここでは結果ボタンを出さない）
            makeUpsHaveSelector();
          } else {
            // 既にUPSフロー開始済み：結果ボタンは upsDone で出す
          }
        } else {
          // UPS対象外はそのまま結果へ
          addResultButton();
        }
        return;
      }

      if (data.comment !== undefined){
        addCommentBox(data.field, data.comment);
        selected[data.field] = "";
        proceed();
        return;
      }

      if (data.skip){
        selected[data.field] = "";
        proceed();
        return;
      }

      if (data.options){
        makeSelect(data.field, data.options, data.auto_select);
        return;
      }
    }

    document.addEventListener("DOMContentLoaded", proceed);
  </script>
</body>
</html>
